<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="src/icon/wspnicon.ico">
  <title>WSPN DSK CONTROL</title>
  <link rel="stylesheet" href="css/control.css" />
</head>
<body>
  <div class="top">
    <img src="src/icon/wspnicon.ico">
    <h1>WSPN DSK</h1><span class="topline"></span><p>Baseball</p>
    <button class="dsk_open" onclick="opendsker()">CG창 열기</button>
  </div>
  <div class="coder-ctrl">
    <button class="coder-btn" onclick="toggleCoder()">CODER ON/OFF</button>
    <div class="coder-status" id="coderStatus">OFF</div>
    <span class="line"></span>
    <p style="color: black;">A</p>
    <input type="number" id="away-sc" value="0" min="0">
    <input type="text" id="away-tn" placeholder="AWAY" ><p>:</p>
    <input type="text" id="home-tn" placeholder="HOME"><p>:</p>
    <input type="number" id="home-sc" value="0" min="0">
    <p style="color: #27C0A2;">H</p>
    <button class="coder-go" onclick="Coderchange()">GO</button>
  </div>
  <div class="map">
    <img src="src/img/map.png">
    <button class="base2" onclick="toggleBase2()"></button>
    <div class="bases">
      <button class="base3" onclick="toggleBase3()"></button>
      <button class="base1" onclick="toggleBase1()"></button>
    </div>
  </div>
  <div class="state">
    <button class="K" onclick="toggleOutK()">Out K<br><b>3sec Auto</b></button>
    <button class="K" onclick="toggleNoOutK()">No Out K<br><b>3sec Auto</b></button>
    <button class="homerun" onclick="toggleHomrun()">Home-run<br><b>3sec Auto</b></button>
    <button class="homerun" onclick="toggle2Homrun()">2-Home-run<br><b>3sec Auto</b></button>
    <button class="homerun threehomerun" onclick="toggle3Homrun()">3-Home-run<br><b>3sec Auto</b></button>
  </div>
  <h1 class="title">Event Log</h1>
  <div id="logArea">
    <p></p>
  </div>

  <script>
    const ws = new WebSocket('ws://localhost:5000'); // 전역에 한 번만 선언

    ws.onopen = () => {
      console.log('WebSocket 연결됨');
    };

    ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);

          // 로그 출력
          const logParagraph = document.querySelector('#logArea p');
          if (msg.type === 'log' && logParagraph) {
            const logLine = document.createElement('div');

            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
            });

            logLine.textContent = `${timeString} :: ${msg.payload}`;
            logParagraph.appendChild(logLine);
            logParagraph.scrollTop = logParagraph.scrollHeight;
            return;
          }

          // 점수 업데이트 메시지는 무시
          if (msg.type === 'score-update') {
            console.log('점수 메시지 수신:', msg.payload);
            return;
          }

        } catch (e) {
          // 일반 텍스트 메시지 (ex: coder-on)
          const msg = event.data;
          const coderStatus = document.getElementById('coderStatus');

          if (msg === 'coder-on') {
            coderStatus.innerText = 'ON';
            coderStatus.style.backgroundColor = '#27C0A2';
          } else if (msg === 'coder-off') {
            coderStatus.innerText = 'OFF';
            coderStatus.style.backgroundColor = '#131313';
          } else if (
            msg === 'base1-on' || msg === 'base1-off' ||
            msg === 'base2-on' || msg === 'base2-off' ||
            msg === 'base3-on' || msg === 'base3-off' ||
            msg === 'outk-on' || msg === 'no-outk-on' ||
            msg === 'homerun-on' || msg === '2homerun-on' ||
            msg === '3homerun-on'
          ) {
            console.log('메시지 수신:', msg);
          } else {
            coderStatus.innerText = 'ERR';
            coderStatus.style.backgroundColor = 'red';
            console.error('알 수 없는 메시지:', msg);
          }
        }
      };

    let isRectangleVisible = false;

    function opendsker() {
      window.open('http://localhost:5000/wspndskeyer.html', '_blank');
    }

    /*코더 ON/OFF*/
    let isCoderOn = false;

    function toggleCoder() {
      if (ws.readyState === WebSocket.OPEN) {
        const msg = isCoderOn ? 'coder-off' : 'coder-on';
        ws.send(msg);
        console.log('메시지 전송:', msg);
        isCoderOn = !isCoderOn;
      }
    }

    /*베이스 ON/OFF*/
    let isBase1On = false;

    function toggleBase1() {
      const button = document.querySelector('.base1');

      if (ws.readyState === WebSocket.OPEN) {
        const msg = isBase1On ? 'base1-off' : 'base1-on';
        ws.send(msg);
        console.log('메시지 전송:', msg);
        button.style.backgroundColor = isBase1On ? '#c7c7c7' : '#27C0A2';
        isBase1On = !isBase1On;
      } else {
        console.warn('WebSocket이 아직 연결되지 않았습니다.');
      }
    }

    let isBase2On = false;

    function toggleBase2() {
      const button = document.querySelector('.base2');

      if (ws.readyState === WebSocket.OPEN) {
        const msg = isBase2On ? 'base2-off' : 'base2-on';
        ws.send(msg);
        console.log('메시지 전송:', msg);
        button.style.backgroundColor = isBase2On ? '#c7c7c7' : '#27C0A2';

        isBase2On = !isBase2On;
      } else {
        console.warn('WebSocket이 아직 연결되지 않았습니다.');
      }
    }

    let isBase3On = false;

    function toggleBase3() {
      const button = document.querySelector('.base3');

      if (ws.readyState === WebSocket.OPEN) {
        const msg = isBase3On ? 'base3-off' : 'base3-on';
        ws.send(msg);
        console.log('메시지 전송:', msg);
        button.style.backgroundColor = isBase3On ? '#c7c7c7' : '#27C0A2';

        isBase3On = !isBase3On;
      } else {
        console.warn('WebSocket이 아직 연결되지 않았습니다.');
      }
    }

    /*코더 점수 변경*/
      function Coderchange() {
      const awayTeam = document.getElementById('away-tn').value.trim();
      const homeTeam = document.getElementById('home-tn').value.trim();
      const awayScore = document.getElementById('away-sc').value;
      const homeScore = document.getElementById('home-sc').value;

      if (awayTeam === '' || homeTeam === '') {
      alert('팀 이름을 모두 입력해주세요.');
      return;
      }

      const message = {
        type: 'score-update',
        payload: {
          awayTeam,
          homeTeam,
          awayScore,
          homeScore
        }
      };

      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(message));
      }
    }

    /*out K*/
    function toggleOutK() {
      if (ws.readyState === WebSocket.OPEN) {
        const msg = 'outk-on';
        ws.send(msg);
      }
    }
    /*no out K*/
    function toggleNoOutK() {
      if (ws.readyState === WebSocket.OPEN) {
        const msg = 'no-outk-on';
        ws.send(msg);
      }
    }

    /*home run*/
    function toggleHomrun() {
      if (ws.readyState === WebSocket.OPEN) {
        const msg = 'homerun-on';
        ws.send(msg);
      }
    }
    /*2home run*/
    function toggle2Homrun() {
      if (ws.readyState === WebSocket.OPEN) {
        const msg = '2homerun-on';
        ws.send(msg);
      }
    }
    /*3home run*/
    function toggle3Homrun() {
      if (ws.readyState === WebSocket.OPEN) {
        const msg = '3homerun-on';
        ws.send(msg);
      }
    }
  </script>
</body>
</html>
